@model NotesTakerApp.Core.Models.Note

@{
    ViewData["Title"] = "Note Details";
}

<h3 class="text-center mt-4">@Model.Title</h3>

<div class="container mt-4" style="max-width: 600px;">
    <form asp-action="Edit" asp-controller="Notes" method="post">
        <input type="hidden" name="Id" value="@Model.Id" />

        <div class="form-group">
            <label for="content">Content</label>
            <textarea class="form-control" name="Content" id="content" rows="10" required>@Model.Content</textarea>
        </div>

        <button type="submit" class="btn btn-primary mt-3 w-100">Save</button>
    </form>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
    <script>
        const noteId = @Model.Id;
        const contentBox = document.getElementById("content");

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notesHub")
            .build();

        connection.on("ReceiveNoteUpdate", function (content) {
            if (document.activeElement !== contentBox) {
                contentBox.value = content;
            }
        });

        async function startConnection() {
            try {
                await connection.start();
                await connection.invoke("JoinNoteGroup", noteId);
            } catch (err) {
                console.error(err.toString());
                setTimeout(startConnection, 5000);
            }
        }

        contentBox.addEventListener("input", () => {
            connection.invoke("SendNoteUpdate", noteId, contentBox.value)
                .catch(err => console.error(err.toString()));
        });

        startConnection();
    </script>
}
